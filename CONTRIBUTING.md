# Contributing

Thank you for your interest in contributing! You can contribute by filing [issues](https://github.com/stepchowfun/typical/issues) and submitting [pull requests](https://github.com/stepchowfun/typical/pulls). Please observe our [code of conduct](https://github.com/stepchowfun/typical/blob/main/CODE_OF_CONDUCT.md).

If you submit a pull request, please ensure your change passes the [GitHub Actions](https://github.com/stepchowfun/typical/actions) CI checks. This will be apparent from the required status check(s) in the pull request.

## Rust style guide

We're fortunate to have good tooling around enforcing a consistent style throughout the codebase. If you have [Toast](https://github.com/stepchowfun/toast), you can run the various lint checks by running `toast lint`. Otherwise, you can rely on our CI to do it for you. Here, we make note of a few conventions which are not yet enforced automatically. Please adhere to these conventions when possible, and provide appropriate justification for deviations from this guide. If you notice any style violations which appear unintentional, we invite you to bring them to our attention.

### Comments

**Rule:** Comments should be written in American English.

**Rule:** Comments should always be capitalized unless they start with a code-like expression (see below).

**Rule:** Comments which are sentences should be punctuated appropriately. For example:

```rust
// The following logic implements beta reduction.
```

**Rule:** Comments which are not sentences should not have a trailing period. For example:

```rust
// Already normalized
```

**Rule:** Code-like expressions, such as variable names, should be surrounded by backticks. For example:

```rust
// `source_range` is a half-open interval, closed on the left and open on the right.
```

### Trailing commas

The linter enforces that items in multi-line sequences (e.g., function arguments and macro arguments) have trailing commas.

**Rule:** Macros should be written to accept trailing commas as follows:

```rust
macro_rules! my_macro {
    ($foo:expr, $bar:expr, $baz:expr $(,)?) => {{
        ...
    }};
}
```

### The Rust code generation unit test

The Rust code generator has a unit test which contains a large string of generated code produced from the schemas in `integration-tests/types`. This generated code generally doesn't adhere to the 100-column line length limit enforced by the lint CI check. The following Ruby script can be used to wrap the lines for inclusion in the unit test such that they conform to the line length limit:

```ruby
#!/usr/bin/env ruby

MAX_COLUMNS = 100

File.read('integration-tests/rust/src/types.rs').each_line do |line|
  line.gsub!('\\', '\\\\\\\\')
  line.gsub!('"', '\\"')

  indentation = line[/\A */] + '    '

  while line
    if line.size <= MAX_COLUMNS
      puts(line)
      break
    end

    split_index = MAX_COLUMNS - 1

    while line[split_index] == ' '
      split_index -= 1

      if split_index == 0
        STDERR.puts('Unable to format the file.')
        exit(1)
      end
    end

    trailing_word_prefix = line[0...split_index][/\b(\w+|\W+)\Z/]
    if trailing_word_prefix && trailing_word_prefix.size != split_index
      split_index -= trailing_word_prefix.size
    end

    if split_index > 1 && line[split_index - 1] != ' '
      space_rindex = line.rindex(' ', split_index - 2)
      if space_rindex && space_rindex + 1 > indentation.size + 4
          split_index = space_rindex + 1
      end
    end

    puts(line[0...split_index] + '\\')

    line = indentation + line[split_index..]
  end
end
```

## Style guides for generated code

### Rust

Generated Rust code should follow the same guidelines as handwritten code. In addition, the automated CI checks that apply to handwritten code also check the code generated by the integration test scenarios, with the exception of the line length limit.

To ensure it'll pass Rust and [Clippy](https://github.com/rust-lang/rust-clippy) lint checks now and in the future, the generated code disables the lint checks as follows:

```rust
#![allow(clippy::all, clippy::pedantic, clippy::nursery, warnings)]
```

However, our policy is that generated code should pass all checks in `clippy::all`, `clippy::pedantic`, and `warnings`, with the following exemptions:

```rust
#![allow(
    clippy::cast_possible_truncation,
    clippy::identity_op,
    clippy::let_unit_value,
    clippy::match_single_binding,
    clippy::module_name_repetitions,
    clippy::no_effect,
    clippy::similar_names,
    clippy::too_many_lines,
    clippy::unit_arg,
    clippy::useless_conversion,
    dead_code,
    unused_variables,
)]
```

This isn't currently enforced by any CI check. The list of exempt checks can be amended as needed to accommodate future developments, but such amendments must be justified.

To ensure the generated code doesn't cause code formatting checks to fail, the generated code also disables [Rustfmt](https://github.com/rust-lang/rustfmt) for all top-level constructs as follows:

```rust
#[rustfmt::skip]
```

Our policy is that the generated code should be formatted in the same style as handwritten code when doing so doesn't add significant complexity to the code generator, although this is also not enforced by any CI check. The formatting of handwritten code is enforced by Rustfmt in a CI check.
